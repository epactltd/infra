# Docker Compose for Production Environment
# Usage: docker compose -f docker-compose.prod.yml up -d
#
# SECURITY NOTES:
# - MySQL and Redis are on a private internal network (not exposed to public)
# - API is internal-only, accessed via frontend proxy
# - Only HQ and Tenant frontends are exposed publicly
# - WebSocket (Reverb) is exposed for real-time features
# - In production, use a reverse proxy (Nginx/Traefik) in front of this stack
#
# NETWORK ARCHITECTURE:
# ┌─────────────────────────────────────────────────────────────────┐
# │                         PUBLIC                                   │
# │                           │                                      │
# │                    ┌──────┴──────┐                              │
# │                    │ Load Balancer│ (Nginx/Traefik - optional)  │
# │                    └──────┬──────┘                              │
# │              ┌────────────┼────────────┐                        │
# │              ▼            ▼            ▼                        │
# │         ┌────────┐  ┌────────┐  ┌──────────┐                   │
# │         │   HQ   │  │ Tenant │  │  Reverb  │ ◄─ WebSocket      │
# │         │ :3000  │  │ :3001  │  │  :8080   │                   │
# │         └────┬───┘  └────┬───┘  └────┬─────┘                   │
# │              │           │           │                          │
# │              └─────┬─────┴───────────┘                          │
# │                    │  envelope_frontend (bridge)                │
# ├────────────────────┼────────────────────────────────────────────┤
# │                    ▼                                            │
# │              ┌──────────┐  ┌──────────┐                        │
# │              │   API    │  │  Worker  │                        │
# │              │  :8000   │  │  (queue) │                        │
# │              └────┬─────┘  └────┬─────┘                        │
# │                   │             │                               │
# │                   └──────┬──────┘                               │
# │                          │  envelope_backend (internal)         │
# ├──────────────────────────┼──────────────────────────────────────┤
# │                          ▼                                      │
# │              ┌──────────┐  ┌──────────┐                        │
# │              │  MySQL   │  │  Redis   │                        │
# │              │  :3306   │  │  :6379   │                        │
# │              └──────────┘  └──────────┘                        │
# │                    envelope_data (internal)                     │
# └─────────────────────────────────────────────────────────────────┘

services:
  # -------------------------------------------------------------------------
  # Backend Services (Laravel) - INTERNAL ONLY
  # -------------------------------------------------------------------------
  api:
    build:
      context: ../api
      dockerfile: Dockerfile
      args:
        - APP_ENV=production
    image: envelope-api:prod
    pull_policy: build
    container_name: envelope_api_prod
    restart: always
    # NO PORTS EXPOSED - accessed internally via frontend proxy
    expose:
      - "${OCTANE_PORT:-8000}"
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_NAME: ${APP_NAME:-Envelope}
      APP_URL: ${APP_URL:-https://api.envelope.host}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      OCTANE_SERVER: ${OCTANE_SERVER:-swoole}
      OCTANE_PORT: ${OCTANE_PORT:-8000}
      REVERB_HOST: ${REVERB_HOST:-0.0.0.0}
      REVERB_PORT: ${REVERB_PORT:-8080}
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_APP_SECRET: ${REVERB_APP_SECRET}
      REVERB_APP_ID: ${REVERB_APP_ID}
      # CORS Configuration
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      # Mail Configuration
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-noreply@envelope.host}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Envelope}
      # Cache and Session
      CACHE_DRIVER: ${CACHE_DRIVER:-redis}
      SESSION_DRIVER: ${SESSION_DRIVER:-redis}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - envelope_backend
      - envelope_data
    healthcheck:
      test: [ "CMD", "php", "-r", "echo 'OK';" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  worker:
    build:
      context: ../api
      dockerfile: Dockerfile
      args:
        - APP_ENV=production
    image: envelope-api:prod
    pull_policy: build
    container_name: envelope_worker_prod
    restart: always
    command: [ "/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/worker.conf", "-n" ]
    # NO PORTS - internal worker process
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_NAME: ${APP_NAME:-Envelope}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      CACHE_DRIVER: ${CACHE_DRIVER:-redis}
      SESSION_DRIVER: ${SESSION_DRIVER:-redis}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - envelope_backend
      - envelope_data
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # WebSocket server - needs to be accessible for real-time features
  # In production, this should be behind a reverse proxy with WSS
  reverb:
    build:
      context: ../api
      dockerfile: Dockerfile
      args:
        - APP_ENV=production
    image: envelope-api:prod
    pull_policy: build
    container_name: envelope_reverb_prod
    restart: always
    command: [ "php", "artisan", "reverb:start", "--host=0.0.0.0", "--port=${REVERB_PORT:-8080}" ]
    ports:
      # WebSocket port - in production, put behind reverse proxy with SSL
      - "${REVERB_HOST_PORT:-8080}:${REVERB_PORT:-8080}"
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_NAME: ${APP_NAME:-Envelope}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REVERB_HOST: 0.0.0.0
      REVERB_PORT: ${REVERB_PORT:-8080}
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_APP_SECRET: ${REVERB_APP_SECRET}
      REVERB_APP_ID: ${REVERB_APP_ID}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - envelope_frontend
      - envelope_data
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # -------------------------------------------------------------------------
  # Frontend Services (Nuxt) - PUBLIC FACING
  # -------------------------------------------------------------------------
  tenant:
    build:
      context: ../tenant
      dockerfile: Dockerfile
    image: envelope-tenant:prod
    pull_policy: build
    container_name: envelope_tenant_prod
    restart: always
    ports:
      - "${TENANT_PORT:-3001}:3000"
    environment:
      NODE_ENV: production
      APP_ENV: ${APP_ENV:-production}
      PORT: 3000
      # BASE_URL is used by the API proxy - points to internal API
      BASE_URL: http://api:${OCTANE_PORT:-8000}
      TENANT_PRIMARY_DOMAIN: ${TENANT_PRIMARY_DOMAIN:-envelope.host}
      RECAPTCHA_V2_SITEKEY: ${RECAPTCHA_V2_SITEKEY}
      # Reverb Configuration - public WebSocket URL
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_HOST: ${REVERB_PUBLIC_HOST:-localhost}
      REVERB_PORT: ${REVERB_HOST_PORT:-8080}
      REVERB_CLUSTER: ${REVERB_CLUSTER}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - envelope_frontend
      - envelope_backend
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  hq:
    build:
      context: ../hq
      dockerfile: Dockerfile
    image: envelope-hq:prod
    pull_policy: build
    container_name: envelope_hq_prod
    restart: always
    ports:
      - "${HQ_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      APP_ENV: ${APP_ENV:-production}
      PORT: 3000
      # BASE_URL is used by the API proxy - points to internal API
      BASE_URL: http://api:${OCTANE_PORT:-8000}
      BASE_DOMAIN: ${BASE_DOMAIN}
      TENANT_PRIMARY_DOMAIN: ${TENANT_PRIMARY_DOMAIN:-envelope.host}
      RECAPTCHA_V2_SITEKEY: ${RECAPTCHA_V2_SITEKEY}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - envelope_frontend
      - envelope_backend
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # -------------------------------------------------------------------------
  # Infrastructure Services - PRIVATE INTERNAL NETWORK
  # -------------------------------------------------------------------------
  mysql:
    image: mariadb:10.11
    pull_policy: if_not_present
    container_name: envelope_mysql_prod
    restart: always
    # NO PORTS EXPOSED - internal only
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - envelope_data
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  redis:
    image: redis:7-alpine
    pull_policy: if_not_present
    container_name: envelope_redis_prod
    restart: always
    # NO PORTS EXPOSED - internal only
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - envelope_data
    healthcheck:
      test: [ "CMD", "redis-cli", "${REDIS_PASSWORD:+--pass $REDIS_PASSWORD}", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

# -------------------------------------------------------------------------
# Networks - Layered security architecture
# -------------------------------------------------------------------------
networks:
  # Public-facing network for frontend services
  envelope_frontend:
    driver: bridge
    
  # Internal network for API <-> Frontend communication
  envelope_backend:
    driver: bridge
    internal: false  # Frontends need to reach API
    
  # Isolated network for data services (MySQL, Redis)
  # Only accessible by API and Worker
  envelope_data:
    driver: bridge
    internal: true  # Completely isolated from external access

# -------------------------------------------------------------------------
# Persistent Volumes
# -------------------------------------------------------------------------
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
