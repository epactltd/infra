# Docker Compose for Production Environment
# Usage: docker compose -f docker-compose.prod.yml up -d
# This configuration:
# - Uses pre-built production images (no volumes)
# - Optimized for production performance
# - No watch mode or development tools
# - Production-ready environment variables

services:
  # -------------------------------------------------------------------------
  # Backend Services (Laravel)
  # -------------------------------------------------------------------------
  api:
    build:
      context: ../api
      dockerfile: Dockerfile
      args:
        - APP_ENV=production
    image: envelope-api:prod
    pull_policy: build
    container_name: envelope_api_prod
    restart: always
    ports:
      - "${OCTANE_HOST_PORT:-8008}:${OCTANE_PORT:-8000}" # Octane
      - "${REVERB_HOST_PORT:-8080}:${REVERB_PORT:-8080}" # Reverb WebSocket
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      APP_NAME: ${APP_NAME:-Envelope}
      APP_URL: ${APP_URL:-https://api.example.com}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      OCTANE_SERVER: ${OCTANE_SERVER:-swoole}
      OCTANE_PORT: ${OCTANE_PORT:-8000}
      REVERB_HOST: ${REVERB_HOST:-0.0.0.0}
      REVERB_PORT: ${REVERB_PORT:-8080}
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_APP_SECRET: ${REVERB_APP_SECRET}
      REVERB_APP_ID: ${REVERB_APP_ID}
      # CORS Configuration
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      # Mail Configuration
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-noreply@example.com}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Envelope}
      # Cache and Session
      CACHE_DRIVER: ${CACHE_DRIVER:-redis}
      SESSION_DRIVER: ${SESSION_DRIVER:-redis}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - envelope_net
    healthcheck:
      test: [ "CMD", "php", "-r", "echo 'OK';" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  worker:
    build:
      context: ../api
      dockerfile: Dockerfile
      args:
        - APP_ENV=production
    image: envelope-api:prod
    pull_policy: build
    container_name: envelope_worker_prod
    restart: always
    command: [ "/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/worker.conf", "-n" ]
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      CACHE_DRIVER: ${CACHE_DRIVER:-redis}
      SESSION_DRIVER: ${SESSION_DRIVER:-redis}
      QUEUE_CONNECTION: ${QUEUE_CONNECTION:-redis}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - envelope_net
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # -------------------------------------------------------------------------
  # Frontend Services (Nuxt) - Production Builds
  # -------------------------------------------------------------------------
  tenant:
    build:
      context: ../tenant
      dockerfile: Dockerfile
    image: envelope-tenant:prod
    pull_policy: build
    container_name: envelope_tenant_prod
    restart: always
    ports:
      - "${TENANT_PORT:-3001}:3000"
    environment:
      NODE_ENV: production
      APP_ENV: ${APP_ENV:-production}
      PORT: 3000
      BASE_URL: ${TENANT_BASE_URL}
      TENANT_PRIMARY_DOMAIN: ${TENANT_PRIMARY_DOMAIN:-envelope.host}
      RECAPTCHA_V2_SITEKEY: ${RECAPTCHA_V2_SITEKEY}
      # API Configuration
      NUXT_API_BASE_SERVER: http://api:8000/api/v1
      NUXT_PUBLIC_API_BASE_CLIENT: ${TENANT_API_URL}/api/v1
      # Reverb Configuration
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_HOST: ${REVERB_HOST}
      REVERB_PORT: ${REVERB_PORT:-8080}
      REVERB_CLUSTER: ${REVERB_CLUSTER}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - envelope_net
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  hq:
    build:
      context: ../hq
      dockerfile: Dockerfile
    image: envelope-hq:prod
    pull_policy: build
    container_name: envelope_hq_prod
    restart: always
    ports:
      - "${HQ_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      APP_ENV: ${APP_ENV:-production}
      PORT: 3000
      BASE_URL: ${HQ_BASE_URL}
      BASE_DOMAIN: ${BASE_DOMAIN}
      TENANT_PRIMARY_DOMAIN: ${TENANT_PRIMARY_DOMAIN:-envelope.host}
      RECAPTCHA_V2_SITEKEY: ${RECAPTCHA_V2_SITEKEY}
      # API Configuration
      NUXT_API_BASE_SERVER: http://api:8000/api/v1
      NUXT_PUBLIC_API_BASE_CLIENT: ${HQ_API_URL}/api/v1
    depends_on:
      api:
        condition: service_healthy
    networks:
      - envelope_net
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # -------------------------------------------------------------------------
  # Infrastructure Services
  # -------------------------------------------------------------------------
  mysql:
    image: mariadb:10.11
    pull_policy: if_not_present
    container_name: envelope_mysql_prod
    restart: always
    ports:
      - "${MYSQL_HOST_PORT:-3307}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - envelope_net
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  redis:
    image: redis:7-alpine
    pull_policy: if_not_present
    container_name: envelope_redis_prod
    restart: always
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - envelope_net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

networks:
  envelope_net:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
