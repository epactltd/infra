# Docker Compose for Development Environment
# Usage: docker compose up -d
# This configuration includes:
# - Volume mounts for live code reloading
# - Watch mode for automatic rebuilds
# - Development-optimized settings

services:
  # -------------------------------------------------------------------------
  # Backend Services (Laravel)
  # -------------------------------------------------------------------------
  api:
    build:
      context: ../api
      dockerfile: Dockerfile
    image: envelope-api:dev
    pull_policy: build
    container_name: envelope_api
    restart: unless-stopped
    ports:
      - "${OCTANE_HOST_PORT:-8008}:${OCTANE_PORT:-8000}" # Octane - Host:Container
      - "${REVERB_HOST_PORT:-8080}:${REVERB_PORT:-8080}" # Reverb WebSocket
    environment:
      APP_ENV: ${APP_ENV:-local}
      APP_DEBUG: ${APP_DEBUG:-true}
      APP_NAME: ${APP_NAME:-Envelope}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-envelope}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      OCTANE_SERVER: ${OCTANE_SERVER:-swoole}
      OCTANE_PORT: ${OCTANE_PORT:-8000}
      REVERB_HOST: ${REVERB_HOST:-0.0.0.0}
      REVERB_PORT: ${REVERB_PORT:-8080}
      REVERB_APP_KEY: ${REVERB_APP_KEY:-}
      REVERB_APP_SECRET: ${REVERB_APP_SECRET:-}
      REVERB_APP_ID: ${REVERB_APP_ID:-}
      # Allow CORS from frontend apps
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:3001,http://localhost:8008"
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS:-noreply@example.com}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Envelope}
    volumes:
      - ../api:/var/www/html
      - /var/www/html/vendor
      - /var/www/html/node_modules
    develop:
      watch:
        - action: sync
          path: ../api
          target: /var/www/html
          ignore:
            - vendor/
            - node_modules/
            - .git/
            - storage/logs/
            - storage/framework/
        - action: rebuild
          path: ../api/composer.lock
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - envelope_net
    healthcheck:
      test: [ "CMD", "php", "-r", "echo 'OK';" ]
      interval: 30s
      timeout: 10s
      retries: 3

  worker:
    build:
      context: ../api
      dockerfile: Dockerfile
    image: envelope-api:dev
    pull_policy: build
    container_name: envelope_worker
    restart: unless-stopped
    command: [ "/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/worker.conf", "-n" ]
    environment:
      APP_ENV: ${APP_ENV:-local}
      APP_DEBUG: ${APP_DEBUG:-true}
      APP_NAME: ${APP_NAME:-Envelope}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-envelope}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    volumes:
      - ../api:/var/www/html
      - /var/www/html/vendor
      - /var/www/html/node_modules
    develop:
      watch:
        - action: sync
          path: ../api
          target: /var/www/html
          ignore:
            - vendor/
            - node_modules/
            - .git/
            - storage/logs/
            - storage/framework/
        - action: rebuild
          path: ../api/composer.lock
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - envelope_net

  # -------------------------------------------------------------------------
  # Frontend Services (Nuxt)
  # -------------------------------------------------------------------------
  tenant:
    build:
      context: ../tenant
      dockerfile: Dockerfile.dev
    image: envelope-tenant:dev
    pull_policy: build
    container_name: envelope_tenant
    restart: unless-stopped
    ports:
      - "${TENANT_PORT:-3001}:3000" # Tenant app
    environment:
      NODE_ENV: development
      APP_ENV: ${APP_ENV:-local}
      PORT: 3000
      BASE_URL: http://api:8000
      TENANT_PRIMARY_DOMAIN: ${TENANT_PRIMARY_DOMAIN:-localhost}
      RECAPTCHA_V2_SITEKEY: ${RECAPTCHA_V2_SITEKEY:-}
      # Reverb Configuration
      REVERB_APP_KEY: ${REVERB_APP_KEY:-}
      REVERB_HOST: ${REVERB_HOST:-localhost}
      REVERB_PORT: ${REVERB_PORT:-8080}
      REVERB_CLUSTER: ${REVERB_CLUSTER:-}
    volumes:
      - ../tenant:/app
      - /app/node_modules
      - /app/.nuxt
      - /app/.output
    develop:
      watch:
        - action: sync
          path: ../tenant
          target: /app
          ignore:
            - node_modules/
            - .git/
            - .output/
            - .nuxt/
            - dist/
        - action: rebuild
          path: ../tenant/package.json
        - action: rebuild
          path: ../tenant/pnpm-lock.yaml
    command: pnpm dev
    depends_on:
      api:
        condition: service_healthy
    networks:
      - envelope_net

  hq:
    build:
      context: ../hq
      dockerfile: Dockerfile.dev
    image: envelope-hq:dev
    pull_policy: build
    container_name: envelope_hq
    restart: unless-stopped
    ports:
      - "${HQ_PORT:-3000}:3000" # HQ app
    environment:
      NODE_ENV: development
      APP_ENV: ${APP_ENV:-local}
      PORT: 3000
      BASE_URL: http://api:8000
      BASE_DOMAIN: ${BASE_DOMAIN:-localhost}
      TENANT_PRIMARY_DOMAIN: ${TENANT_PRIMARY_DOMAIN:-localhost}
      RECAPTCHA_V2_SITEKEY: ${RECAPTCHA_V2_SITEKEY:-}
    volumes:
      - ../hq:/app
      - /app/node_modules
      - /app/.nuxt
      - /app/.output
    develop:
      watch:
        - action: sync
          path: ../hq
          target: /app
          ignore:
            - node_modules/
            - .git/
            - .output/
            - .nuxt/
            - dist/
        - action: rebuild
          path: ../hq/package.json
        - action: rebuild
          path: ../hq/pnpm-lock.yaml
    command: pnpm dev
    depends_on:
      api:
        condition: service_healthy
    networks:
      - envelope_net

  # -------------------------------------------------------------------------
  # Infrastructure Services
  # -------------------------------------------------------------------------
  mysql:
    image: mariadb:10.11
    pull_policy: if_not_present
    container_name: envelope_mysql
    restart: unless-stopped
    ports:
      - "${MYSQL_HOST_PORT:-3307}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${DB_DATABASE:-envelope}
      MYSQL_USER: ${DB_USERNAME:-root}
      MYSQL_PASSWORD: ${DB_PASSWORD:-root}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - envelope_net
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    pull_policy: if_not_present
    container_name: envelope_redis
    restart: unless-stopped
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - envelope_net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

  mailpit:
    image: axllent/mailpit:latest
    pull_policy: if_not_present
    container_name: envelope_mailpit
    restart: unless-stopped
    ports:
      - "${MAILPIT_SMTP_PORT:-1025}:1025" # SMTP
      - "${MAILPIT_UI_PORT:-8025}:8025" # Web UI
    environment:
      MP_SMTP_BIND_ADDR: 0.0.0.0:1025
      MP_WEB_BIND_ADDR: 0.0.0.0:8025
    networks:
      - envelope_net

networks:
  envelope_net:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
